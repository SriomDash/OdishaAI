<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Chakadola Journey | Itinerary</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Poppins:wght@300;400;500;600&family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --odia-maroon: #800000;
            --odia-gold: #D4AF37;
            --odia-cream: #FFF8E7;
            --text-dark: #2c1810;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--odia-cream) 0%, #fff 100%);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--odia-maroon), #600000);
            color: var(--odia-gold);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(128,0,0,0.3);
        }

        header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
        }

        .odia-subtitle {
            font-family: 'Baloo 2', cursive;
            font-size: 1.3rem;
            opacity: 0.9;
        }

        /* Loading State */
        .loading { text-align: center; padding: 60px 20px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--odia-maroon);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Layouts */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        
        .map-section, .summary-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid var(--odia-gold);
        }

        #map { height: 500px; border-radius: 15px; border: 3px solid var(--odia-gold); }

        h2 { font-family: 'Cinzel', serif; color: var(--odia-maroon); margin-bottom: 15px; font-size: 1.5rem; }

        /* Custom Marker */
        .custom-marker-pin {
            width: 32px; height: 32px; border-radius: 50%; background-color: var(--odia-maroon);
            border: 2px solid white; color: var(--odia-gold); text-align: center; font-size: 14px;
            font-weight: bold; line-height: 28px; box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        .custom-marker-pin:hover { transform: scale(1.15); background-color: #600000; z-index: 1000 !important; }

        /* Stats & Cost */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--odia-cream); padding: 15px; border-radius: 12px; border-left: 4px solid var(--odia-maroon); }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 1.3rem; font-weight: 600; color: var(--odia-maroon); }
        .cost-breakdown { background: linear-gradient(135deg, #fff9e6, #fff); padding: 20px; border-radius: 15px; margin-top: 20px; border: 2px dashed var(--odia-gold); }
        .cost-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0; }
        .cost-item:last-child { border-bottom: none; font-weight: 600; font-size: 1.1rem; color: var(--odia-maroon); padding-top: 12px; border-top: 2px solid var(--odia-gold); }

        /* --- NEW DAY CARD STYLES --- */
        .day-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 6px solid var(--odia-gold);
            transition: transform 0.3s;
        }
        .day-card:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); }

        .day-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--odia-cream);
        }
        .day-number { font-family: 'Cinzel', serif; font-size: 2rem; color: var(--odia-maroon); font-weight: 700; }
        .date-text { font-size: 1.1rem; font-weight: 600; color: var(--text-dark); }

        /* Destination Card with Image */
        .destinations { display: flex; flex-direction: column; gap: 20px; margin-bottom: 25px; }
        
        .destination-item {
            display: flex;
            background: var(--odia-cream);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(128,0,0,0.1);
        }

        .dest-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .dest-image-container {
            width: 180px;
            height: auto;
            min-height: 120px;
        }

        .dest-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .destination-item:hover .dest-image { transform: scale(1.1); }

        .destination-name { font-size: 1.3rem; font-weight: 700; color: var(--odia-maroon); margin-bottom: 8px; }
        .destination-desc { font-size: 0.95rem; color: #555; line-height: 1.6; margin-bottom: 10px; }
        .entry-fee { display: inline-block; background: var(--odia-gold); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }

        /* Info Grid */
        .day-info-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; background: #fafafa; padding: 15px; border-radius: 12px; }
        .info-label { font-size: 0.7rem; text-transform: uppercase; color: #888; font-weight: 700; margin-bottom: 4px; }
        .info-value { font-size: 0.9rem; font-weight: 600; color: var(--text-dark); }

        /* Tips */
        .tips-section { margin-top: 20px; padding: 15px; background: #fffbe6; border-radius: 10px; border-left: 4px solid #ffc107; display: flex; align-items: flex-start; gap: 10px; }
        .bulb-icon { font-size: 1.2rem; }
        .tips-list { list-style: none; padding: 0; margin: 0; }
        .tips-list li { font-size: 0.9rem; color: #856404; margin-bottom: 4px; }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .day-info-grid { grid-template-columns: 1fr 1fr; }
            .destination-item { flex-direction: column-reverse; }
            .dest-image-container { width: 100%; height: 200px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üïâÔ∏è Your Chakadola Journey</h1>
            <div class="odia-subtitle">‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï ‡¨™‡¨¨‡¨ø‡¨§‡≠ç‡¨∞ ‡¨ì‡¨°‡¨º‡¨ø‡¨∂‡¨æ ‡¨Ø‡¨æ‡¨§‡≠ç‡¨∞‡¨æ</div>
        </header>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h2>Weaving your sacred journey...</h2>
        </div>

        <div id="content" style="display: none;">
            <div class="main-grid">
                <div class="map-section">
                    <h2>üìç Route Map</h2>
                    <div id="map"></div>
                </div>

                <div class="summary-card">
                    <h2>‚ú® Trip Summary</h2>
                    <div class="stat-grid">
                        <div class="stat-box"><div class="stat-label">Duration</div><div class="stat-value" id="duration-stat">-</div></div>
                        <div class="stat-box"><div class="stat-label">Total Places</div><div class="stat-value" id="places-stat">-</div></div>
                        <div class="stat-box"><div class="stat-label">Group Size</div><div class="stat-value" id="group-stat">-</div></div>
                        <div class="stat-box"><div class="stat-label">Type</div><div class="stat-value" id="type-stat">-</div></div>
                    </div>
                    <div class="cost-breakdown">
                        <h3 style="color: var(--odia-maroon); margin-bottom: 15px; font-size: 1.1rem;">üí∞ Cost Breakdown (Per Person)</h3>
                        <div id="cost-items"></div>
                    </div>
                </div>
            </div>

            <div class="itinerary-section">
                <h2 style="text-align: center;">üìÖ Day-wise Itinerary</h2>
                <div id="days-container"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- IMAGE HELPER FUNCTION ---
        // Since we don't have real images in DB, we select based on keywords
        function getPlaceImage(placeName) {
            const name = placeName.toLowerCase();
            
            // Unsplash Source URLs (High Quality)
            if (name.includes('temple') || name.includes('shrine') || name.includes('mandir')) {
                return 'https://images.unsplash.com/photo-1599833975773-5328227b9522?q=80&w=400&auto=format&fit=crop'; // Konark Style
            } 
            else if (name.includes('beach') || name.includes('sea') || name.includes('port')) {
                return 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=400&auto=format&fit=crop'; // Beach
            }
            else if (name.includes('lake') || name.includes('chilika') || name.includes('dam')) {
                return 'https://images.unsplash.com/photo-1558273683-92c222df6746?q=80&w=400&auto=format&fit=crop'; // Lake/Water
            }
            else if (name.includes('waterfall') || name.includes('falls') || name.includes('spring')) {
                return 'https://images.unsplash.com/photo-1432405972618-c60b0225b8f9?q=80&w=400&auto=format&fit=crop'; // Waterfall
            }
            else if (name.includes('wildlife') || name.includes('sanctuary') || name.includes('forest') || name.includes('park')) {
                return 'https://images.unsplash.com/photo-1535941339077-2dd1c7963098?q=80&w=400&auto=format&fit=crop'; // Forest/Deer
            }
            else if (name.includes('palace') || name.includes('fort') || name.includes('museum')) {
                return 'https://images.unsplash.com/photo-1590453530089-2996d929737f?q=80&w=400&auto=format&fit=crop'; // Heritage
            }
            else {
                // Default Odisha Culture Image
                return 'https://images.unsplash.com/photo-1627918507304-48405d4d38ba?q=80&w=400&auto=format&fit=crop'; 
            }
        }

        // --- MAIN LOGIC ---
        let itineraryData = null;
        let mapData = null;

        const stored = localStorage.getItem('chakadola_itinerary');
        if (stored) {
            try {
                const decoded = JSON.parse(stored);
                
                // Backend returns: { success: true, data: { itinerary: {...}, map_data: {...} } }
                // Extract the nested structure properly
                if (decoded.data && decoded.data.itinerary) {
                    itineraryData = decoded.data.itinerary;
                    // Use map_data from data level, fallback to itinerary.map_data
                    mapData = decoded.data.map_data || decoded.data.itinerary.map_data || null;
                } else if (decoded.itinerary) {
                    // Fallback: if structure is different
                    itineraryData = decoded.itinerary;
                    mapData = decoded.map_data || decoded.map || null;
                } else {
                    // Direct structure (old format)
                    itineraryData = decoded;
                    mapData = decoded.map_data || decoded.map || null;
                }

                console.log("üìä Extracted itinerary data:", itineraryData);
                console.log("üó∫Ô∏è Extracted map data:", mapData);

                renderItinerary();
            } catch (e) { 
                console.error("‚ùå Error parsing data", e);
                document.getElementById('loading').innerHTML = `<h3>Error loading data: ${e.message}</h3>`;
            }
        } else {
            document.getElementById('loading').innerHTML = '<h3>No Data Found. Please go back.</h3>';
        }

        function renderItinerary() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Extract data from the correct nested structure
            const summary = itineraryData.trip_summary || itineraryData.summary || {};
            const days = itineraryData.days || [];
            const costSummary = itineraryData.cost_summary || itineraryData.costs || {};



            // Stats
            document.getElementById("duration-stat").innerText =
            summary.duration ? `${summary.duration} Days` : summary.duration_days ? `${summary.duration_days} Days` : "-";

            document.getElementById("places-stat").innerText =
            summary.total_places ?? "-";

            document.getElementById("group-stat").innerText =
            summary.group_size ? `${summary.group_size} People` : "-";

            document.getElementById("type-stat").innerText =
            (summary.vibes && Array.isArray(summary.vibes) ? summary.vibes.join(", ") : summary.vibes) || "Mixed";


            // Cost
            const costContainer = document.getElementById('cost-items');
            const costs = [
                { l: 'Stay', v: costSummary.stay || 0 },
                { l: 'Travel', v: costSummary.travel || 0 },
                { l: 'Food', v: costSummary.food || 0 },
                { l: 'Total / Day', v: costSummary.total_per_person_day || 0 }
            ];
            costs.forEach(c => {
                const value = c.v || 0;
                costContainer.innerHTML += `<div class="cost-item"><span>${c.l}</span><span>‚Çπ${value.toLocaleString('en-IN')}</span></div>`;
            });

            // Map
            if (mapData && mapData.leaflet_points && mapData.leaflet_points.length > 0) {
                renderMap(mapData);
            } else {
                console.warn("‚ö†Ô∏è Map data not available or incomplete");
                document.querySelector('.map-section').innerHTML = '<h2>üìç Route Map</h2><p>Map data unavailable</p>';
            }

            // Days
            const container = document.getElementById('days-container');
            if (days && days.length > 0) {
                days.forEach(day => {
                    try {
                        container.appendChild(createDayCard(day));
                    } catch (e) {
                        console.error("Error creating day card:", e, day);
                    }
                });
            } else {
                container.innerHTML = '<p>No itinerary days found.</p>';
            }
        }

        function createDayCard(day) {
            const card = document.createElement('div');
            card.className = 'day-card';

            // Handle destinations safely
            const destinations = day.destinations || [];
            const destHTML = destinations.map(d => {
                // GET IMAGE BASED ON NAME
                const imgUrl = getPlaceImage(d.name || '');
                const entryFee = d.entry_fee || 0;
                
                return `
                <div class="destination-item">
                    <div class="dest-content">
                        <div class="destination-name">üìç ${d.name || 'Unknown Place'}</div>
                        <div class="destination-desc">${d.description || 'No description available'}</div>
                        ${entryFee > 0 ? `<span class="entry-fee">Entry: ‚Çπ${entryFee}</span>` : '<span class="entry-fee">Free Entry</span>'}
                    </div>
                    <div class="dest-image-container">
                        <img src="${imgUrl}" alt="${d.name || ''}" class="dest-image">
                    </div>
                </div>`;
            }).join('');

            // Handle weather safely
            const weather = day.weather || {};
            const weatherSummary = weather.summary || 'Weather data unavailable';

            // Handle cost breakdown safely
            const costBreakdown = day.cost_breakdown || {};
            const totalCost = costBreakdown.total_per_person_day || 0;
            const activitiesCost = costBreakdown.activities || 0;

            // Handle tips safely
            const tips = day.tips || [];
            const tipsHTML = tips.length > 0 ? `
                <div class="tips-section">
                    <div class="bulb-icon">üí°</div>
                    <ul class="tips-list">${tips.map(t => `<li>${t}</li>`).join('')}</ul>
                </div>` : '';

            card.innerHTML = `
                <div class="day-header">
                    <div class="day-number">Day ${day.day || '?'}</div>
                    <div class="date-text">${day.day_name || day.date || ''}</div>
                </div>
                <div class="destinations">${destHTML || '<p>No destinations planned for this day.</p>'}</div>
                <div class="day-info-grid">
                    <div><div class="info-label">Schedule</div><div class="info-value">${day.time_plan || 'Not specified'}</div></div>
                    <div><div class="info-label">Weather</div><div class="info-value">${weatherSummary}</div></div>
                    <div><div class="info-label">Est. Cost</div><div class="info-value">‚Çπ${totalCost.toLocaleString('en-IN')}</div></div>
                    <div><div class="info-label">Activities</div><div class="info-value">‚Çπ${activitiesCost.toLocaleString('en-IN')}</div></div>
                </div>
                ${tipsHTML}
            `;
            return card;
        }

        function renderMap(data) {
            try {
                // Default center to Odisha if not provided
                const center = data.center || [20.2961, 85.8245];
                const map = L.map('map', { center: center, zoom: 7, minZoom: 5 });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                
                // Add markers
                if (data.leaflet_points && Array.isArray(data.leaflet_points) && data.leaflet_points.length > 0) {
                    data.leaflet_points.forEach((p, i) => {
                        if (p.lat && p.lng) {
                            const icon = L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div class="custom-marker-pin">${i+1}</div>`,
                                iconSize: [32, 32], 
                                iconAnchor: [16, 16]
                            });
                            L.marker([p.lat, p.lng], {icon}).addTo(map).bindPopup(`<b>${p.name || 'Location'}</b>`);
                        }
                    });

                    // Add route polyline
                    if (data.coords_array && Array.isArray(data.coords_array) && data.coords_array.length > 1) {
                        L.polyline(data.coords_array, { color: '#6A040F', weight: 4, opacity: 0.8 }).addTo(map);
                    }
                } else {
                    console.warn("‚ö†Ô∏è No valid leaflet_points found in map data");
                }
            } catch (e) {
                console.error("‚ùå Error rendering map:", e);
                document.querySelector('#map').innerHTML = '<p>Error loading map</p>';
            }
        }
    </script>
</body>
</html>